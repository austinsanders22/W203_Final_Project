---
title: "Lab 2 EDA"
author: "Charles Martin S. Lim"
date: "11/13/2021"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(hash)
library(gridExtra)
library(tidyverse)
library(magrittr)
library(ggplot2)
```

## Steps:
>   1. Load The Data \
>   2. Get Necessary Columns \
>   3. Filter out Low-Budget, Low-Revenue, and Duplicate Titles - 285-295 rows \
>   4. Examine Variables (apply transformations) - log-transformation makes them look normal \
>   5. Compare plot of World Revenue to Budget (color by MPAA rating) - looks like there is a linear trend\
>   6. Check PG-only films - it appears that G and PG are in the same "PG" bucket \


```{r - CONSTANTS, warning = FALSE, include=FALSE}
# Constants to manipulate
MIN_REVENUE = 10000000
MIN_BUDGET = 10000
REMOVE_NA_RATING = FALSE
```

## 1. Load the Data

```{r - LOAD DATA, warning=FALSE}
# Read the dataset
original_data <- read.csv(file = "boxoffice2017_2019.csv")
head(original_data)
```

Outcome variable: \
`world_revenue` - Must be $10,000,000 or more \

Explanatory Variables: \
- `budget`    - Might require a log-transform \
- `MPAA`    - Filter to indicator variables \

## 2. Get Necessary Columns

```{r - GET NECESSARY COLUMNS, warning=FALSE}
convert_to_numeric <- function(df, index){
  return_val <- gsub("\\$", "", df[index])      # Remove $ symbol
  return_val <- gsub(",", "", return_val)       # Remove , symbol
  return_val <- as.numeric(return_val)          # Convert to numeric
  return(return_val)
}

# Retrieve only the needed columns

# Outcome variables
world_revenue <-c(original_data$world_revenue)             # World revenue

opening_revenue <-c(original_data$opening_revenue)    # Opening revenue

domestic_revenue <-c(original_data$domestic_revenue)  # Domestic revenue


# Explanatory variables
budget <-c(original_data$budget)                      # Budget
MPAA <-c(original_data$MPAA)                          # Content Rating

# Add title to remove duplicates
title <-c(original_data$title)

df_raw <- data.frame(world_revenue, opening_revenue,
                     domestic_revenue, budget,
                     MPAA, title)

# Convert number columns to numeric
df_raw$world_revenue = apply(df_raw, 1, convert_to_numeric, 1)
df_raw$opening_revenue = apply(df_raw, 1, convert_to_numeric, 2)
df_raw$domestic_revenue = apply(df_raw, 1, convert_to_numeric, 3)
df_raw$budget = apply(df_raw, 1, convert_to_numeric, 4)

head(df_raw)
```

## 3. Filter out Low-Budget, Low-Revenue, and Duplicate Titles

```{r - DATA CLEANING, warning=FALSE}
# Remove world_revenue under MIN_REVENUE
df_raw <- subset(df_raw, df_raw$world_revenue >= MIN_REVENUE & !is.na(df_raw$world_revenue))

# Remove budget under MIN_BUDGET
df_raw <- subset(df_raw, df_raw$budget >= MIN_BUDGET & !is.na(df_raw$budget))

# Remove N/A ratings if desired
if (REMOVE_NA_RATING) {
  df_raw <- subset(df_raw, df_raw$MPAA != "N/A")
}

# Hash for title : budget
h <- hash() 

# Clean dataframe
df = data.frame()

for(i in 1:nrow(df_raw)) {       # for-loop over rows
  title_key = df_raw[i,6]
  
  if (has.key( title_key, h )) {
    # Title Is already recorded

    # Search for existing row in clean dataframe with the same title
    for (k in 1:nrow(df)) {
      
      if (tolower(title_key) == tolower(df[k,6])) {
        # Replace row if the budget of the new value is higher than that of the
        # budget of the recorded title
        if (df_raw[i, 4] > df[k, 4]) {
          
          # Delete found row in cleaned dataframe
          df = df[!k,]
          
          # Bind raw dataframe row to clean dataframe
          df <- rbind(df, df_raw[i,])
          
          # Revise title_key and budget to hash
          h[[title_key]] = df_raw[i,4]
        }
        
        break
      }
      
    }
    
  } else {
    # Add title_key and budget to hash
    h[[title_key]] = df_raw[i,4]
    
    # Bind raw dataframe row to clean dataframe
    df <- rbind(df, df_raw[i,])
  }
}

# Print number of rows with unique titles
length(df[["title"]])
```

## 4. Examine Variables (apply transformations)

```{r - CHECK MAIN NUMERIC VARIABLES, warning=FALSE}
# CHECK MAIN NUMERIC VARIABLES
world_revenue_histogram <- df %>%
  ggplot(aes(world_revenue)) +
  geom_histogram(bins=30)

log_world_revenue_histogram <- df %>%
  ggplot(aes(log(world_revenue))) +
  geom_histogram(bins=30)

budget_histogram <- df %>%
  ggplot(aes(budget)) +
  geom_histogram(bins=30)

log_budget_histogram <- df %>%
  ggplot(aes(log(budget))) +
  geom_histogram(bins=30)

grid.arrange(world_revenue_histogram, log_world_revenue_histogram,
             budget_histogram, log_budget_histogram,
             nrow = 2, ncol = 2)
```

```{r - CHECK BONUS OUTCOME VARIABLES, warning=FALSE}
# CHECK BONUS OUTCOME VARIABLES
opening_revenue_histogram <- df %>%
  ggplot(aes(opening_revenue,)) +
  geom_histogram(bins=30)

domestic_revenue_histogram <- df %>%
  ggplot(aes(domestic_revenue,)) +
  geom_histogram(bins=30)

log_opening_revenue_histogram <- df %>%
  ggplot(aes(log(opening_revenue))) +
  geom_histogram(bins=30)

log_domestic_revenue_histogram <- df %>%
  ggplot(aes(log(domestic_revenue))) +
  geom_histogram(bins=30)

grid.arrange(opening_revenue_histogram, domestic_revenue_histogram,
             log_opening_revenue_histogram, log_domestic_revenue_histogram,
             nrow = 2, ncol = 2)
```


```{r - CHECK NUMERIC EXPLANATORY VARIABLE, warning=FALSE}
# CHECK NUMERIC EXPLANATORY VARIABLE
budget_histogram <- df %>%
  ggplot(aes(budget)) +
  geom_histogram(bins=30)

log_budget_histogram <- df %>%
  ggplot(aes(log(budget))) +
  geom_histogram(bins=30)


grid.arrange(budget_histogram, log_budget_histogram,
             nrow = 1, ncol = 2)

```

## 5. Compare plot of World Revenue to Budget (color by MPAA rating)

````{r COMPARE EXPLANATORY VARIABLES, warning = FALSE}
# COMPARE EXPLANATORY VARIABLES
level_level_plot <- df %>%
  ggplot(aes(x=budget, y=world_revenue, color=MPAA)) +
  geom_point()

level_log_plot <- df %>%
  ggplot(aes(x=log(budget), y=world_revenue, color=MPAA)) +
  geom_point()

log_level_plot <- df %>%
  ggplot(aes(x=budget, y=log(world_revenue), color=MPAA)) +
  geom_point()

log_log_plot <- df %>%
  ggplot(aes(x=log(budget), y=log(world_revenue), color=MPAA)) +
  geom_point()

grid.arrange(level_level_plot, level_log_plot,
             log_level_plot, log_log_plot,
             nrow = 2, ncol = 2)
````
## 6. Check PG-only films

```{r CHECK PG-RATED FILMS, warning = FALSE}
# CHECK PG-RATED FILMS (it appears that G and PG are in the same "PG" bucket)
df_pg <- subset(df, df$MPAA != "PG-13" & df$MPAA != "R" & df$MPAA != "N/A")
df_pg
```